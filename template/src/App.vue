<template>
  <div id="app">
    {{#router}}
    <div v-if="CONFIG_ROLE !== null">
      <THeader v-if="isOrgApp"></THeader>
      <div :class="isOrgApp ? 'main' : 'main no-header-sider'">
        <tSider v-if="isOrgApp"></tSider>
        <div class="content">
            <router-view></router-view>
        </div>
      </div>
    </div>
    <div v-if="no_auth === true" class="no-auth">
      <div>
        暂无权限，请联系管理员！咚咚号：fpe
      </div>
    </div>
    {{else}}
    <Demo/>
    {{/router}}
  </div>
</template>

<script>
{{#unless router}}
import Demo from './components/Demo'
{{/unless}}
import THeader from '@/common-components/THeader'
import TSider from '@/common-components/TSider'
import { CONFIG, CONFIG_ROLE, CONFIG_IS_AUTH } from './services/config'
export default {
  name: 'App',
  components: {
    THeader,
    TSider{{#router}}{{else}},
    Demo{{/router}}
  },
  data () {
    return {
      CONFIG_ROLE: null,
      no_auth: false,
      isOrgApp: CONFIG.getQueryString('isOrgApp') == 'false' ? false : 1
    }
  },
  methods: {
    loadData () {
      window.$.ajax({
        url: CONFIG.URL.querypermcontent,
        type: 'GET',
        data: {
          systemid: 'fulfillment-cost'
        },
        // dataType: 'jsonp',
        xhrFields: {
          withCredentials: true
        },
        success: (res, textStatus, jqXHR) => {
          // console.log('ok!!!!', res)
          // res = res.data
          // console.log('前端配置', CONFIG_ROLE)
          if (res.statusCode === 1) {
            let CONFIG_ROLE_RES = res.data
            // console.log('????', CONFIG_ROLE_RES)
            let tmp = {}
            // console.log('获取权限ok', CONFIG_ROLE_RES)
            for (let i = 0; i < CONFIG_ROLE.length; i++) {
              for (let j = 0; j < CONFIG_ROLE_RES.length; j++) {
                if (CONFIG_ROLE[i].id === CONFIG_ROLE_RES[j].id) {
                  CONFIG_ROLE[i].checked = CONFIG_ROLE_RES[j].checked
                  if (CONFIG_ROLE[i].checked === 'true') {
                    tmp[CONFIG_ROLE[i].id] = true
                  } else {
                    tmp[CONFIG_ROLE[i].id] = false
                  }
                }
              }
            }
            window.CONFIG_ROLE = this.CONFIG_ROLE = tmp
            // console.log(this.CONFIG_ROLE)
          } else {
            this.no_auth = true
          }
        },
        error: (xhr, textStatus) => {
          console.log('错误')
          // this.no_auth = true
          this.$Message.error('获取权限失败!')
        }
      })
    }
  },
  mounted () {
    if (CONFIG_IS_AUTH) {
      this.loadData()
    } else {
      let tmp = {}
      for (let i = 0; i < CONFIG_ROLE.length; i++) {
        tmp[CONFIG_ROLE[i].id] = CONFIG_ROLE[i].checked
      }
      window.CONFIG_ROLE = this.CONFIG_ROLE = tmp
    }
  }
}
</script>

